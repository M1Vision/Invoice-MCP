# ğŸ”’ Security & Privacy Guide for Invoice MCP

## â“ Your Question: "Won't everyone be able to steal my invoice information?"

**Excellent question!** You're absolutely right to be concerned about security. Here's how we've addressed this:

## ğŸ›¡ï¸ Security Architecture

### **PRIVATE Buckets (Not Public!)**

Your invoice PDFs are stored in a **PRIVATE** Supabase Storage bucket:

âœ… **What this means:**
- Bucket is NOT publicly accessible
- Files cannot be listed or browsed
- Direct URL access is blocked
- Only authenticated requests can access files

âŒ **What would happen with a public bucket (BAD):**
- Anyone could guess filenames and download invoices
- Sensitive client data would be exposed
- Business information would be accessible to anyone
- **This is why we DON'T use public buckets!**

## ğŸ” How Signed URLs Work

Instead of public URLs, we use **Signed URLs** (also called "Pre-signed URLs"):

### **What are Signed URLs?**

A signed URL is a temporary, secure link that:
1. âœ… Expires after 7 days (configurable)
2. âœ… Contains a cryptographic token that can't be forged
3. âœ… Only works for the specific file
4. âœ… Can only be generated by your server (with your credentials)

### **Example:**

**âŒ BAD (Public URL):**
```
https://yourproject.supabase.co/storage/v1/object/public/invoices/invoice-001.pdf
# Anyone with this URL can access the invoice forever
# Anyone can guess other invoice numbers: invoice-002.pdf, invoice-003.pdf, etc.
```

**âœ… GOOD (Signed URL):**
```
https://yourproject.supabase.co/storage/v1/object/sign/invoices/invoice-001.pdf?token=eyJhbGci...XYZ123
# Only works for 7 days
# Token is cryptographically signed (can't be forged or guessed)
# Different token for each file
# After 7 days, the link stops working
```

## ğŸ“Š Security Comparison

| Feature | Public Bucket | Private Bucket + Signed URLs |
|---------|--------------|------------------------------|
| **Direct access** | âŒ Anyone can access | âœ… Only with signed URL |
| **URL guessing** | âŒ Can guess invoice-001, 002, etc. | âœ… Impossible (unique tokens) |
| **Time limit** | âŒ Links work forever | âœ… Expires after 7 days |
| **Browsing** | âŒ Can list all files | âœ… Cannot list files |
| **Token forgery** | âŒ Not applicable | âœ… Cryptographically impossible |
| **Revocation** | âŒ Can't revoke access | âœ… URLs expire automatically |

## ğŸ¯ Real-World Security Benefits

### **Scenario 1: Sharing with a Client**
```
You: Generate invoice for Acme Corp
Server: Creates PDF in PRIVATE bucket
Server: Generates signed URL (expires in 7 days)
You: Share URL with client via email
Client: Downloads invoice within 7 days
After 7 days: URL stops working (no more access)
```

âœ… **Client can access THEIR invoice**
âœ… **Client CANNOT access OTHER invoices** (each has unique token)
âœ… **Automatic expiration** (no manual cleanup needed)

### **Scenario 2: Malicious Actor**
```
Attacker: Tries to access your Supabase storage
Bucket: Private - access denied
Attacker: Tries to guess filenames
Server: Returns 403 Forbidden (even if filename is correct)
Attacker: Tries to forge a signed URL
Supabase: Validates token - cryptographic verification fails
Result: âœ… No access to any invoices
```

## ğŸ”§ Configuration for Maximum Security

### **Step 1: Create PRIVATE Bucket in Supabase**

1. Go to Supabase Dashboard â†’ Storage
2. Click "New Bucket"
3. Name: `invoices`
4. **Public bucket: LEAVE UNCHECKED** âš ï¸ (This is critical!)
5. Save

### **Step 2: Set Storage Policies**

Apply these policies in Supabase SQL Editor:

```sql
-- Allow authenticated users to upload (your server uses auth)
CREATE POLICY "Authenticated Upload" ON storage.objects
FOR INSERT TO authenticated
WITH CHECK (bucket_id = 'invoices');

-- Allow authenticated users to generate signed URLs
CREATE POLICY "Authenticated Access" ON storage.objects
FOR SELECT TO authenticated
USING (bucket_id = 'invoices');
```

### **Step 3: Use Your Anon Key**

Your server uses the Supabase **anon key** which:
- âœ… Can upload to private buckets (with proper policies)
- âœ… Can generate signed URLs
- âŒ Cannot list all files (security)
- âŒ Cannot delete buckets (safety)

## â±ï¸ URL Expiration

Default: **7 days** (604,800 seconds)

### **Why 7 days?**
- Long enough for clients to download invoices
- Short enough to prevent long-term exposure
- Balances convenience and security

### **Need different expiration times?**

You can customize in the code (`index-smithery-robust.ts`):

```typescript
// Current: 7 days
.createSignedUrl(filename, 604800);

// Options:
// 1 hour:   3600
// 24 hours: 86400
// 30 days:  2592000
```

## ğŸš€ What You Need to Do

1. âœ… **Create bucket as PRIVATE** (not public)
2. âœ… **Set storage policies** (see SQL above)
3. âœ… **Use anon key** (already in your config)
4. âœ… **Deploy the updated code** (with signed URLs)

## ğŸ“‹ Security Checklist

Before going to production:

- [ ] Supabase bucket is PRIVATE (not public)
- [ ] Storage policies are configured correctly
- [ ] Using anon key (not service role key in production)
- [ ] Server generates signed URLs (not public URLs)
- [ ] Tested that old URLs expire after 7 days
- [ ] Tested that unauthorized access is denied
- [ ] SSL/HTTPS is enabled on your deployment

## ğŸ†˜ FAQ

### **Q: What happens after 7 days?**
A: The signed URL expires and returns a 401 Unauthorized error. You can generate a new signed URL for the same file if needed.

### **Q: Can I make URLs permanent?**
A: Technically yes (set expiration to 10 years), but it's **not recommended** for sensitive invoice data. Time-limited access is a security best practice.

### **Q: What if a client needs access after 7 days?**
A: You can retrieve the file from storage and generate a new signed URL. Consider implementing a "resend invoice" feature.

### **Q: Is the anon key safe to use?**
A: Yes! The anon key is designed for client-side use with Row Level Security (RLS) policies. For your use case (MCP server), it's perfect because:
- Server authenticates with Supabase using the key
- Policies restrict what can be accessed
- Signed URLs provide time-limited access

### **Q: Should I use a service role key instead?**
A: **Only if you need to auto-create buckets.** Otherwise, stick with anon key:
- Anon key: Limited permissions (safer)
- Service role key: Full admin access (more dangerous if leaked)

## ğŸ‰ Summary

âœ… **Your invoices are secure:**
- Private bucket (not publicly accessible)
- Signed URLs (time-limited, can't be forged)
- Proper authentication (anon key + policies)
- Automatic expiration (7 days)

âœ… **You can safely:**
- Share URLs with clients
- Email invoice links
- Store URLs in your database
- Trust that only authorized people can access

âœ… **You don't need to worry about:**
- Random people accessing invoices
- URL guessing or brute-forcing
- Permanent exposure of sensitive data
- Manual URL cleanup

---

**Your concern was 100% valid, and we've built the security architecture to address it properly!** ğŸ”’

